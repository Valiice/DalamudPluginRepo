name: Update Plugin Releases and Stats

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-json:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: pip install requests

      - name: Update repo.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 <<'EOF'
          import json, re, requests, time, os
          from datetime import datetime

          GITHUB_TOKEN = os.environ.get('GITHUB_TOKEN')
          HEADERS = {}
          if GITHUB_TOKEN:
              HEADERS['Authorization'] = f"token {GITHUB_TOKEN}"

          REPO_FILE = "repo.json"

          def get_owner_repo(url):
              m = re.search("github\\.com/([^/]+)/([^/]+)", url.strip("/"))
              return m.groups() if m else (None, None)

          def to_unix_timestamp(iso_str):
              if not iso_str:
                  return None
              try:
                  dt = datetime.strptime(iso_str, "%Y-%m-%dT%H:%M:%SZ")
                  return int(dt.timestamp())
              except Exception:
                  return None

          with open(REPO_FILE, "r") as f:
              plugins = json.load(f)

          updated = False
          for plugin in plugins:
              repo_url = plugin.get("RepoUrl")
              if not repo_url:
                  print(f"Skipping {plugin.get('InternalName')} - no RepoUrl")
                  continue

              owner, repo = get_owner_repo(repo_url)
              if not owner or not repo:
                  print(f"Skipping {plugin.get('InternalName')} - invalid RepoUrl: {repo_url}")
                  continue

              latest_url = f"https://api.github.com/repos/{owner}/{repo}/releases/latest"
              print(f"Fetching latest release for {plugin.get('InternalName')} ({latest_url})")
              
              latest_release = None
              try:
                resp_latest = requests.get(latest_url, headers=HEADERS)
                resp_latest.raise_for_status()
                latest_release = resp_latest.json()
                
                new_version = latest_release.get("tag_name", "").lstrip("v")
                
                new_download_url = None
                for asset in latest_release.get("assets", []):
                    if asset.get("name", "").endswith(".zip"):
                        new_download_url = asset.get("browser_download_url")
                        break

                if new_version and new_download_url:
                    if plugin.get("AssemblyVersion") != new_version:
                        print(f"  > New version found: {new_version}")
                        plugin["AssemblyVersion"] = new_version
                        plugin["DownloadLinkInstall"] = new_download_url
                        plugin["DownloadLinkUpdate"] = new_download_url
                        plugin["DownloadLinkTesting"] = new_download_url
                        updated = True
                    else:
                        print(f"  > Version {new_version} is already up-to-date.")
                    
                    new_changelog = latest_release.get("body", "No changelog provided.")
                    if plugin.get("Changelog") != new_changelog:
                        print(f"  > Updating changelog.")
                        plugin["Changelog"] = new_changelog
                        updated = True
                
                else:
                    print(f"  > Could not find new version or zip asset for {plugin.get('InternalName')}")

              except requests.exceptions.RequestException as e:
                print(f"  > Failed to fetch latest release (Version/Changelog): {e}")


              all_releases_url = f"https://api.github.com/repos/{owner}/{repo}/releases?per_page=100"
              print(f"Fetching all releases for stats ({all_releases_url})")
              
              try:
                resp_all = requests.get(all_releases_url, headers=HEADERS)
                resp_all.raise_for_status()
                all_releases = resp_all.json()

                total_downloads = sum(
                    a.get("download_count", 0)
                    for r in all_releases
                    for a in r.get("assets", [])
                    if a.get("name", "").endswith(".zip")
                )
                
                if plugin.get("DownloadCount") != total_downloads:
                   print(f"  > Updating download count: {total_downloads}")
                   plugin["DownloadCount"] = total_downloads
                   updated = True
                
                all_dates = []
                for r in all_releases:
                    if r.get("published_at"):
                        all_dates.append(r.get("published_at"))
                    elif r.get("created_at"):
                        all_dates.append(r.get("created_at"))
                
                last_updated_iso = max(all_dates, default=None)
                last_updated_unix = to_unix_timestamp(last_updated_iso)

                if last_updated_unix is not None:
                    if plugin.get("LastUpdate") != last_updated_unix:
                        print(f"  > Updating last update time: {last_updated_unix}")
                        plugin["LastUpdate"] = last_updated_unix
                        updated = True
                else:
                    print("  > Could not determine LastUpdate date (no published releases found, retaining old value).")

              except requests.exceptions.RequestException as e:
                 print(f"  > Failed to fetch all releases (Download/Update Time): {e}")

              time.sleep(1)


          if updated:
              print("Updates found. Writing to repo.json.")
              with open(REPO_FILE, "w") as f:
                  json.dump(plugins, f, indent=2)
          else:
              print("No changes to apply.")
          EOF

      - name: Commit
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add repo.json
          git commit -m "Update plugin versions and stats" || echo "No changes to commit"

      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref_name }}