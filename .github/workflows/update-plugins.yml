name: Update Plugin Releases and Stats

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-json:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: pip install requests

      - name: Update repo.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 <<'EOF'
          import json, re, requests, time, os
          from datetime import datetime

          GITHUB_TOKEN = os.environ.get('GITHUB_TOKEN')
          HEADERS = {}
          if GITHUB_TOKEN:
              HEADERS['Authorization'] = f"token {GITHUB_TOKEN}"

          REPO_FILE = "repo.json"

          def get_owner_repo(url):
              m = re.search("github\\.com/([^/]+)/([^/]+)", url.strip("/"))
              return m.groups() if m else (None, None)

          def to_unix_timestamp(iso_str):
              if not iso_str:
                  return None
              try:
                  dt = datetime.strptime(iso_str, "%Y-%m-%dT%H:%M:%SZ")
                  return int(dt.timestamp())
              except Exception:
                  return None

          def verify_and_fix_url(url, preferred_branch):
              if not url: return url
              
              try:
                  if requests.head(url).status_code == 200:
                      return url
              except:
                  pass
              
              new_url = url
              if preferred_branch == "master" and "/main/" in url:
                  new_url = url.replace("/main/", "/master/")
              elif preferred_branch == "main" and "/master/" in url:
                  new_url = url.replace("/master/", "/main/")
              
              if new_url != url:
                  try:
                      if requests.head(new_url).status_code == 200:
                          print(f"    (Auto-fixed broken URL: {new_url})")
                          return new_url
                  except:
                      pass

              return url

          with open(REPO_FILE, "r") as f:
              plugins = json.load(f)

          updated = False
          for plugin in plugins:
              repo_url = plugin.get("RepoUrl")
              internal_name = plugin.get("InternalName")
              
              if not repo_url or not internal_name:
                  print(f"Skipping {internal_name} - missing RepoUrl or InternalName")
                  continue

              owner, repo = get_owner_repo(repo_url)
              if not owner or not repo:
                  print(f"Skipping {internal_name} - invalid RepoUrl: {repo_url}")
                  continue

              manifest_candidates = [
                  (f"https://raw.githubusercontent.com/{owner}/{repo}/master/{internal_name}.json", "master"),
                  (f"https://raw.githubusercontent.com/{owner}/{repo}/main/{internal_name}.json", "main"),
                  (f"https://raw.githubusercontent.com/{owner}/{repo}/master/{internal_name}/{internal_name}.json", "master"),
                  (f"https://raw.githubusercontent.com/{owner}/{repo}/main/{internal_name}/{internal_name}.json", "main")
              ]

              manifest_data = None
              detected_branch = "master" # Default fallback

              for url, branch in manifest_candidates:
                  try:
                      r = requests.get(url)
                      if r.status_code == 200:
                          manifest_data = r.json()
                          detected_branch = branch
                          print(f"  > Found source manifest for {internal_name} on branch '{branch}'")
                          break
                  except:
                      continue

              if manifest_data:
                  raw_icon = manifest_data.get("IconUrl")
                  if raw_icon:
                      fixed_icon = verify_and_fix_url(raw_icon, detected_branch)
                      if fixed_icon != plugin.get("IconUrl"):
                          print(f"  > Updating IconUrl")
                          plugin["IconUrl"] = fixed_icon
                          updated = True
                  
                  raw_images = manifest_data.get("ImageUrls", [])
                  fixed_images = []
                  for img in raw_images:
                      fixed_images.append(verify_and_fix_url(img, detected_branch))
                  
                  if fixed_images != plugin.get("ImageUrls"):
                      print(f"  > Updating ImageUrls")
                      plugin["ImageUrls"] = fixed_images
                      updated = True
                  
                  for field in ["Punchline", "Description", "Tags"]:
                      val = manifest_data.get(field)
                      if val and val != plugin.get(field):
                          print(f"  > Updating {field}")
                          plugin[field] = val
                          updated = True

              latest_url = f"https://api.github.com/repos/{owner}/{repo}/releases/latest"
              
              try:
                resp_latest = requests.get(latest_url, headers=HEADERS)
                resp_latest.raise_for_status()
                latest_release = resp_latest.json()
                
                new_version = latest_release.get("tag_name", "").lstrip("v")
                
                new_download_url = None
                for asset in latest_release.get("assets", []):
                    if asset.get("name", "").endswith(".zip"):
                        new_download_url = asset.get("browser_download_url")
                        break

                if new_version and new_download_url:
                    if plugin.get("AssemblyVersion") != new_version:
                        print(f"  > New version found: {new_version}")
                        plugin["AssemblyVersion"] = new_version
                        plugin["DownloadLinkInstall"] = new_download_url
                        plugin["DownloadLinkUpdate"] = new_download_url
                        plugin["DownloadLinkTesting"] = new_download_url
                        updated = True
                    
                    new_changelog = latest_release.get("body", "No changelog provided.")
                    if plugin.get("Changelog") != new_changelog:
                        plugin["Changelog"] = new_changelog
                        updated = True

              except requests.exceptions.RequestException as e:
                print(f"  > Failed to fetch latest release: {e}")

              all_releases_url = f"https://api.github.com/repos/{owner}/{repo}/releases?per_page=100"
              
              try:
                resp_all = requests.get(all_releases_url, headers=HEADERS)
                resp_all.raise_for_status()
                all_releases = resp_all.json()

                total_downloads = sum(
                    a.get("download_count", 0)
                    for r in all_releases
                    for a in r.get("assets", [])
                    if a.get("name", "").endswith(".zip")
                )
                
                if plugin.get("DownloadCount") != total_downloads:
                   plugin["DownloadCount"] = total_downloads
                   updated = True
                
                all_dates = []
                for r in all_releases:
                    if r.get("published_at"):
                        all_dates.append(r.get("published_at"))
                    elif r.get("created_at"):
                        all_dates.append(r.get("created_at"))
                
                last_updated_iso = max(all_dates, default=None)
                last_updated_unix = to_unix_timestamp(last_updated_iso)

                if last_updated_unix is not None:
                    if plugin.get("LastUpdate") != last_updated_unix:
                        plugin["LastUpdate"] = last_updated_unix
                        updated = True

              except requests.exceptions.RequestException as e:
                 print(f"  > Failed to fetch all releases: {e}")

              time.sleep(1)

          if updated:
              print("Updates found. Writing to repo.json.")
              with open(REPO_FILE, "w") as f:
                  json.dump(plugins, f, indent=2)
          else:
              print("No changes to apply.")
          EOF

      - name: Commit
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add repo.json
          git commit -m "Update plugin versions and stats" || echo "No changes to commit"

      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref_name }}