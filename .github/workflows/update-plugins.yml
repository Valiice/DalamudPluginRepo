name: Update Plugin Releases and Stats

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-json:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: pip install requests

      - name: Update repo.json and README.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 <<'EOF'
          import json, re, requests, time, os
          from datetime import datetime

          GITHUB_TOKEN = os.environ.get('GITHUB_TOKEN')
          HEADERS = {}
          if GITHUB_TOKEN:
              HEADERS['Authorization'] = f"token {GITHUB_TOKEN}"

          REPO_FILE = "repo.json"
          README_FILE = "README.md"
          
          START_MARKER = "START_MARKER"
          END_MARKER = "END_MARKER"

          def get_owner_repo(url):
              if not url: return (None, None)
              m = re.search("github\\.com/([^/]+)/([^/]+)", url.strip("/"))
              return m.groups() if m else (None, None)

          def verify_and_fix_url(url, preferred_branch):
              if not url: return url
              try:
                  if requests.head(url).status_code == 200:
                      return url
              except:
                  pass
              
              new_url = url
              if preferred_branch == "master" and "/main/" in url:
                  new_url = url.replace("/main/", "/master/")
              elif preferred_branch == "main" and "/master/" in url:
                  new_url = url.replace("/master/", "/main/")
              
              if new_url != url:
                  try:
                      if requests.head(new_url).status_code == 200:
                          return new_url
                  except:
                      pass
              return url

          def update_readme(plugins_list):
              if not os.path.exists(README_FILE):
                  print("README.md not found, skipping table update.")
                  return False

              lines = ["| Plugin Name | Description | Source |", "| :--- | :--- | :---: |"]
              
              for p in plugins_list:
                  name = p.get("Name", "Unknown")
                  desc = p.get("Description", "")
                  punch = p.get("Punchline", "")
                  url = p.get("RepoUrl", "")
                  
                  if punch:
                      full_desc = f"**{punch}**<br>{desc}"
                  else:
                      full_desc = desc
                  
                  full_desc = full_desc.replace("\n", " ").replace("|", "-")
                  
                  lines.append(f"| **{name}** | {full_desc} | [Repo]({url}) |")
              
              table_content = "\n".join(lines)
              
              with open(README_FILE, "r") as f:
                  content = f.read()

              start_idx = content.find(START_MARKER)
              end_idx = content.find(END_MARKER)

              if start_idx == -1 or end_idx == -1:
                  print("Markers not found in README.md. Please ensure START_MARKER and END_MARKER exist.")
                  return False
              
              pre_content = content[:start_idx + len(START_MARKER)]
              
              post_content = content[end_idx:]
              
              new_content = f"{pre_content}\n{table_content}\n{post_content}"

              if new_content != content:
                  with open(README_FILE, "w") as f:
                      f.write(new_content)
                  print("README.md updated with new plugin list.")
                  return True
              return False


          with open(REPO_FILE, "r") as f:
              plugins = json.load(f)

          updated = False
          
          for plugin in plugins:
              repo_url = plugin.get("RepoUrl")
              internal_name = plugin.get("InternalName")
              
              if not repo_url or not internal_name:
                  continue

              owner, repo = get_owner_repo(repo_url)
              if not owner or not repo:
                  continue

              manifest_candidates = [
                  (f"https://raw.githubusercontent.com/{owner}/{repo}/master/{internal_name}.json", "master"),
                  (f"https://raw.githubusercontent.com/{owner}/{repo}/main/{internal_name}.json", "main"),
                  (f"https://raw.githubusercontent.com/{owner}/{repo}/master/{internal_name}/{internal_name}.json", "master"),
                  (f"https://raw.githubusercontent.com/{owner}/{repo}/main/{internal_name}/{internal_name}.json", "main")
              ]

              manifest_data = None
              detected_branch = "master"

              for url, branch in manifest_candidates:
                  try:
                      r = requests.get(url)
                      if r.status_code == 200:
                          manifest_data = r.json()
                          detected_branch = branch
                          print(f"  > Found manifest for {internal_name} ({branch})")
                          break
                  except:
                      continue

              if manifest_data:
                  for field in ["Punchline", "Description", "Tags", "Name"]:
                      val = manifest_data.get(field)
                      if val and val != plugin.get(field):
                          plugin[field] = val
                          updated = True
                  
                  if manifest_data.get("IconUrl"):
                      fixed = verify_and_fix_url(manifest_data["IconUrl"], detected_branch)
                      if fixed != plugin.get("IconUrl"):
                          plugin["IconUrl"] = fixed
                          updated = True

                  raw_imgs = manifest_data.get("ImageUrls", [])
                  fixed_imgs = [verify_and_fix_url(i, detected_branch) for i in raw_imgs]
                  if fixed_imgs != plugin.get("ImageUrls"):
                      plugin["ImageUrls"] = fixed_imgs
                      updated = True

              latest_url = f"https://api.github.com/repos/{owner}/{repo}/releases/latest"
              try:
                  resp = requests.get(latest_url, headers=HEADERS)
                  if resp.status_code == 200:
                      rel = resp.json()
                      ver = rel.get("tag_name", "").lstrip("v")
                      
                      dl_link = next((a["browser_download_url"] for a in rel.get("assets", []) if a["name"].endswith(".zip")), None)

                      if ver and dl_link and plugin.get("AssemblyVersion") != ver:
                          print(f"  > New version {ver} for {internal_name}")
                          plugin["AssemblyVersion"] = ver
                          plugin["DownloadLinkInstall"] = dl_link
                          plugin["DownloadLinkUpdate"] = dl_link
                          plugin["DownloadLinkTesting"] = dl_link
                          plugin["Changelog"] = rel.get("body", "")
                          updated = True
              except Exception as e:
                  print(f"  > Error fetching release for {internal_name}: {e}")
              
              time.sleep(1)

          if updated:
              print("Updating repo.json...")
              with open(REPO_FILE, "w") as f:
                  json.dump(plugins, f, indent=2)
          
          readme_changed = update_readme(plugins)
          
          if not updated and not readme_changed:
              print("No changes needed.")
          EOF

      - name: Commit
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add repo.json README.md
          git commit -m "Update plugin versions, stats, and README" || echo "No changes to commit"

      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref_name }}